{% extends "base.html" %}

{% block title %}Checkout - POS System{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900">Checkout</h1>
        <p class="text-gray-600">Complete the sale and process payment</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Cart Summary -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Order Summary</h2>
            
            {% if cart %}
            <div class="space-y-3 mb-6">
                {% for item in cart %}
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex-1">
                        <h4 class="font-medium text-sm">{{ item.name }}</h4>
                        <p class="text-xs text-gray-500">{{ "%.2f"|format(item.price) }} each</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-blue-600">{{ "%.2f"|format(item.total) }}</p>
                        <p class="text-xs text-gray-500">Qty: {{ item.quantity }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="border-t pt-4 space-y-3">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Subtotal:</span>
                    <span class="font-medium">{{ "%.2f"|format(cart|sum(attribute='total')) }}</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Tax (5%):</span>
                    <span class="font-medium">{{ "%.2f"|format(cart|sum(attribute='total') * 0.05) }}</span>
                </div>
                <div class="flex justify-between text-lg font-bold">
                    <span>Total:</span>
                    <span class="text-blue-600">{{ "%.2f"|format(cart|sum(attribute='total') * 1.05) }}</span>
                </div>
            </div>
            {% else %}
            <div class="text-center text-gray-500 py-8">
                <i class="fas fa-shopping-cart text-4xl mb-2"></i>
                <p>Cart is empty</p>
                <a href="{{ url_for('sales.pos') }}" class="text-blue-600 hover:text-blue-800">
                    Return to POS
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Checkout Form -->
        {% if cart %}
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Payment Details</h2>
            
            <form method="POST" class="space-y-4">
                <!-- Customer Selection -->
                <div>
                    <label for="customer_id" class="block text-sm font-medium text-gray-700 mb-1">
                        Customer (Optional)
                    </label>
                    <select name="customer_id" id="customer_id" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Walk-in Customer</option>
                        {% for customer in customers %}
                        <option value="{{ customer.id }}">
                            {{ customer.name }} - {{ customer.phone or 'No phone' }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Payment Method -->
                <div>
                    <label for="payment_method" class="block text-sm font-medium text-gray-700 mb-1">
                        Payment Method *
                    </label>
                    <select name="payment_method" id="payment_method" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select payment method</option>
                        <option value="cash">Cash</option>
                        <option value="card">Card</option>
                        <option value="mobile_money">Mobile Money</option>
                        <option value="split">Split Payment</option>
                    </select>
                </div>

                <!-- Discount -->
                <div>
                    <label for="discount_amount" class="block text-sm font-medium text-gray-700 mb-1">
                        Discount Amount
                    </label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">
                            {{ "GHS" }}
                        </span>
                        <input type="number" name="discount_amount" id="discount_amount" 
                               step="0.01" min="0" max="{{ cart|sum(attribute='total') }}"
                               value="0.00"
                               class="w-full pl-12 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="0.00">
                    </div>
                </div>

                <!-- Split Payment Details (Hidden by default) -->
                <div id="splitPaymentDetails" class="hidden space-y-3 p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-medium text-gray-900">Split Payment Details</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Method 1</label>
                            <select name="split_method_1" class="w-full px-2 py-1 text-sm border border-gray-300 rounded">
                                <option value="cash">Cash</option>
                                <option value="card">Card</option>
                                <option value="mobile_money">Mobile Money</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Amount 1</label>
                            <input type="number" name="split_amount_1" step="0.01" min="0"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded"
                                   placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Method 2</label>
                            <select name="split_method_2" class="w-full px-2 py-1 text-sm border border-gray-300 rounded">
                                <option value="cash">Cash</option>
                                <option value="card">Card</option>
                                <option value="mobile_money">Mobile Money</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Amount 2</label>
                            <input type="number" name="split_amount_2" step="0.01" min="0"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded"
                                   placeholder="0.00">
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex space-x-3 pt-4">
                    <a href="{{ url_for('sales.pos') }}" 
                       class="flex-1 px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 text-center">
                        Back to POS
                    </a>
                    <button type="submit" 
                            class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        <i class="fas fa-credit-card mr-2"></i>
                        Complete Sale
                    </button>
                </div>
            </form>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Only run JavaScript if cart exists
{% if cart %}
// Show/hide split payment details based on payment method
const paymentMethodSelect = document.getElementById('payment_method');
if (paymentMethodSelect) {
    paymentMethodSelect.addEventListener('change', function() {
        const splitDetails = document.getElementById('splitPaymentDetails');
        if (this.value === 'split') {
            splitDetails.classList.remove('hidden');
        } else {
            splitDetails.classList.add('hidden');
        }
    });
}

// Validate split payment amounts
const form = document.querySelector('form');
if (form) {
    form.addEventListener('submit', function(e) {
        const paymentMethod = document.getElementById('payment_method').value;
        
        // Ensure payment method is selected
        if (!paymentMethod) {
            e.preventDefault();
            alert('Please select a payment method.');
            return false;
        }
        
        // Ensure discount amount is valid
        const discountInput = document.getElementById('discount_amount');
        if (discountInput) {
            const discountValue = discountInput.value.trim();
            if (discountValue === '' || discountValue === null) {
                discountInput.value = '0.00';
            }
        }
        
        if (paymentMethod === 'split') {
            const amount1 = parseFloat(document.querySelector('input[name="split_amount_1"]').value) || 0;
            const amount2 = parseFloat(document.querySelector('input[name="split_amount_2"]').value) || 0;
            const total = {{ cart|sum(attribute='total') * 1.05 }};
            
            if (Math.abs((amount1 + amount2) - total) > 0.01) {
                e.preventDefault();
                alert('Split payment amounts must equal the total amount.');
                return false;
            }
        }
    });
}

// Auto-calculate discount impact
const discountInput = document.getElementById('discount_amount');
if (discountInput) {
    discountInput.addEventListener('input', function() {
        const discount = parseFloat(this.value) || 0;
        const subtotal = {{ cart|sum(attribute='total') }};
        const tax = subtotal * 0.05;
        const total = subtotal + tax - discount;
        
        // Update total display in cart summary
        const totalElement = document.querySelector('.text-blue-600');
        if (totalElement) {
            totalElement.textContent = total.toFixed(2);
        }
    });
}
{% endif %}
</script>
{% endblock %}
